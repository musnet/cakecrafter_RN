// src/components/gallery/EnhancedCakeGallery.js
// Communication #64.3 - UI/UX ENHANCED: Improved price visibility & add-to-cart button
// üöÄ FIXED: Now uses local JSON data from SuperDuperHomeScreen instead of API
// ‚ö° OPTIMIZED: Loads 12 images per batch, infinite scroll pagination
// üé® LUXURY: Qatar-branded masonry layout with beautiful animations
// üåê i18n: Full Arabic/English RTL/LTR support
// ‚ú® LAZY: LazyImage component prevents memory overload
// üîß DATA FLOW: Uses cakes prop directly, API as fallback
// üõí NEW: Enhanced price display & add-to-cart functionality

import React, { useState, useEffect, useRef, useCallback } from 'react';
import {
  View,
  FlatList,
  Dimensions,
  Animated,
  RefreshControl,
  ActivityIndicator,
  Text,
  TouchableOpacity,
} from 'react-native';
import { LinearGradient } from 'expo-linear-gradient';
import { useTranslation } from 'react-i18next';

// Import components
import LazyImage from '../common/LazyImage'; // ‚ú® HIGH-performance image loading
import { QatarColors, Spacing, Typography } from '../../styles/theme';
import { ApiService } from '../../services/ApiService';

const { width, height } = Dimensions.get('window');
const COLUMN_COUNT = 2; // Masonry columns
const ITEM_MARGIN = Spacing.sm;
const COLUMN_WIDTH = (width - Spacing.md * 2 - ITEM_MARGIN * (COLUMN_COUNT - 1)) / COLUMN_COUNT;

// ‚ú® PERFORMANCE SETTINGS - Communication #62.4
const PERFORMANCE_CONFIG = {
  INITIAL_BATCH_SIZE: 12,      // Load only 12 images initially (was 150+)
  PAGINATION_SIZE: 8,          // Load 8 more images per scroll
  PRELOAD_THRESHOLD: 0.7,      // Start loading when 70% scrolled
  MAX_RENDERED_ITEMS: 20,      // Virtualization limit
  IMAGE_PRIORITY_DELAY: 100,   // ms delay between image loads
};

// ================================
// ENHANCED CAKE GALLERY COMPONENT - Communication #64.3
// ================================
const EnhancedCakeGallery = ({ 
  galleryImages = [], 
  cakes = [], 
  onCakePress,
  onAddToCart, // üõí NEW: Add-to-cart handler
  currentLanguage = 'en',
  style,
  selectedCategory = null,
  onCategoryDataLoaded = null,
}) => {
  
  // ============================================================================
  // HOOKS & STATE (ENHANCED FOR PERFORMANCE) - Communication #62.4
  // ============================================================================
  
  const { t } = useTranslation();
  const [galleryData, setGalleryData] = useState([]);
  const [loading, setLoading] = useState(false);
  const [refreshing, setRefreshing] = useState(false);
  const [page, setPage] = useState(1);
  const [hasMoreData, setHasMoreData] = useState(true);
  const [columnHeights, setColumnHeights] = useState(Array(COLUMN_COUNT).fill(0));
  const [layoutMode, setLayoutMode] = useState('masonry');
  
  // ‚ú® PERFORMANCE STATE - Communication #62.4
  const [loadedImageCount, setLoadedImageCount] = useState(0);
  const [totalImageCount, setTotalImageCount] = useState(0);
  const [loadingProgress, setLoadingProgress] = useState(0);
  const [isInitialLoad, setIsInitialLoad] = useState(true);
  
  // Category-specific state
  const [categoryCakes, setCategoryCakes] = useState([]);
  const [categoryLoading, setCategoryLoading] = useState(false);
  const [currentCategoryKey, setCurrentCategoryKey] = useState(null);
  
  // ‚ú® NEW: Data source tracking - Communication #62.4
  const [dataSource, setDataSource] = useState('unknown'); // 'props', 'api', 'unknown'
  
  // Animation refs
  const scrollY = useRef(new Animated.Value(0)).current;
  const galleryOpacity = useRef(new Animated.Value(0)).current;
  const headerScale = useRef(new Animated.Value(0.8)).current;
  
  // üõí NEW: Add-to-cart animation refs - Communication #64.3
  const addToCartScale = useRef(new Animated.Value(1)).current;
  
  // Performance refs
  const imageLoadQueue = useRef([]);
  const loadTimeoutRef = useRef(null);
  
  // ============================================================================
  // LIFECYCLE & EFFECTS (PERFORMANCE OPTIMIZED) - Communication #62.4
  // ============================================================================
  
  useEffect(() => {
    initializeGallery();
    startEntranceAnimation();
    
    // Cleanup on unmount
    return () => {
      if (loadTimeoutRef.current) {
        clearTimeout(loadTimeoutRef.current);
      }
    };
  }, []);
  
  // Category change detection with performance optimization
  useEffect(() => {
    if (selectedCategory && selectedCategory.key !== currentCategoryKey) {
      console.log(`üéØ Communication #62.4 - Category changed: ${currentCategoryKey} ‚Üí ${selectedCategory.key}`);
      handleCategoryChangeOptimized(selectedCategory);
    }
  }, [selectedCategory]);
  
  // ‚ú® NEW: Watch for cakes prop changes - Communication #62.4
  useEffect(() => {
    if (cakes.length > 0 && selectedCategory) {
      console.log(`üç∞ Communication #62.4 - PROPS: Using cakes from props (${cakes.length} cakes)`);
      handleLocalCakesData(cakes, selectedCategory);
    }
  }, [cakes, selectedCategory]);
  
  // Optimized category cakes integration
  useEffect(() => {
    if (categoryCakes.length > 0) {
      createOptimizedMasonryData();
    }
  }, [categoryCakes, layoutMode]);
  
  // ============================================================================
  // ‚ú® NUCLEAR FIXED: LOCAL JSON DATA HANDLING - Communication #62.4
  // ============================================================================
  
  const handleLocalCakesData = (localCakes, category) => {
    try {
      console.log(`üîÑ Communication #62.4 - NUCLEAR: Processing ${localCakes.length} local cakes for ${category.name}`);
      
      setDataSource('props');
      setCategoryLoading(true);
      setCurrentCategoryKey(category.key);
      setIsInitialLoad(true);
      setLoadedImageCount(0);
      setLoadingProgress(0);
      
      // ‚ú® PERFORMANCE: Clear previous data immediately
      setGalleryData([]);
      setCategoryCakes([]);
      
      // Reset pagination
      setPage(1);
      setHasMoreData(localCakes.length > PERFORMANCE_CONFIG.INITIAL_BATCH_SIZE);
      
      // Format local cakes for gallery display
      const formattedCakes = formatLocalCakesOptimized(localCakes, category);
      
      // Apply initial batch limit for performance
      const initialBatch = formattedCakes.slice(0, PERFORMANCE_CONFIG.INITIAL_BATCH_SIZE);
      
      setCategoryCakes(initialBatch);
      setTotalImageCount(formattedCakes.length);
      
      console.log(`‚úÖ Communication #62.4 - NUCLEAR: Loaded ${initialBatch.length}/${formattedCakes.length} local cakes (batch 1)`);
      
      // Store remaining cakes for pagination
      window.remainingLocalCakes = formattedCakes.slice(PERFORMANCE_CONFIG.INITIAL_BATCH_SIZE);
      
      // Notify parent
      if (onCategoryDataLoaded) {
        onCategoryDataLoaded(initialBatch, category);
      }
      
    } catch (error) {
      console.error(`‚ùå Communication #62.4 - Error processing local cakes:`, error);
      setCategoryCakes([]);
      setTotalImageCount(0);
    } finally {
      setCategoryLoading(false);
      setIsInitialLoad(false);
    }
  };
  
  const formatLocalCakesOptimized = (localCakes, category) => {
    return localCakes.map((cake, index) => ({
      id: `local_${category.key}_${index}_${Date.now()}`,
      type: 'cake',
      image: cake.image || cake.image_url,
      height: getRandomHeight(),
      name: cake.name || cake.nameAr || 'Delicious Cake',
      nameAr: cake.nameAr || cake.name || 'ŸÉŸäŸÉÿ© ŸÑÿ∞Ÿäÿ∞ÿ©',
      price: cake.price || 'QAR 199',
      rating: cake.rating || 4.8,
      category: category.key,
      categoryName: category.name,
      description: cake.description || `Beautiful ${category.name.toLowerCase()} cake`,
      isNew: cake.isNew || false,
      purchases: cake.purchases || 0,
      // ‚ú® PERFORMANCE: Add loading priority
      priority: index < 6 ? 'high' : 'normal', // First 6 images get high priority
      batchIndex: Math.floor(index / PERFORMANCE_CONFIG.PAGINATION_SIZE),
      // ‚ú® NUCLEAR: Mark as local data
      dataSource: 'local',
    }));
  };
  
  // ============================================================================
  // ‚ú® PERFORMANCE OPTIMIZED CATEGORY HANDLING - Communication #62.4
  // ============================================================================
  
  const handleCategoryChangeOptimized = async (category) => {
    try {
      console.log(`üîÑ Communication #62.4 - OPTIMIZED: Loading cakes for category: ${category.name}`);
      
      // ‚ú® NUCLEAR FIX: Check if we have local cakes from props
      if (cakes && cakes.length > 0) {
        console.log(`üéØ Communication #62.4 - Using LOCAL JSON data (${cakes.length} cakes) instead of API`);
        handleLocalCakesData(cakes, category);
        return; // Exit early, use local data
      }
      
      // ‚ú® FALLBACK: Use API only if no local cakes available
      console.log(`üåê Communication #62.4 - FALLBACK: No local cakes, trying API for ${category.name}`);
      
      setDataSource('api');
      setCategoryLoading(true);
      setCurrentCategoryKey(category.key);
      setIsInitialLoad(true);
      setLoadedImageCount(0);
      setLoadingProgress(0);
      
      // ‚ú® PERFORMANCE: Clear previous data immediately
      setGalleryData([]);
      setCategoryCakes([]);
      
      // Reset pagination with smaller initial batch
      setPage(1);
      setHasMoreData(true);
      
      // Clear image cache and fetch with pagination
      const categoryData = await ApiService.getCakesByCategory(category.key, {
        limit: PERFORMANCE_CONFIG.INITIAL_BATCH_SIZE, // Only 12 images initially
        page: 1,
        clearPrevious: true
      });
      
      if (categoryData && categoryData.results) {
        const formattedCakes = formatCakesFromAPIOptimized(categoryData.results, category);
        setCategoryCakes(formattedCakes);
        setTotalImageCount(categoryData.count || formattedCakes.length);
        
        console.log(`‚úÖ Communication #62.4 - API: Loaded ${formattedCakes.length} cakes (batch 1/${Math.ceil((categoryData.count || 0) / PERFORMANCE_CONFIG.INITIAL_BATCH_SIZE)})`);
        
        // Notify parent
        if (onCategoryDataLoaded) {
          onCategoryDataLoaded(formattedCakes, category);
        }
      } else {
        console.log(`‚ö†Ô∏è Communication #62.4 - No cakes found for category: ${category.name}`);
        setCategoryCakes([]);
        setTotalImageCount(0);
      }
      
    } catch (error) {
      console.error(`‚ùå Communication #62.4 - Error loading category ${category?.name}:`, error);
      setCategoryCakes([]);
      setTotalImageCount(0);
    } finally {
      setCategoryLoading(false);
      setIsInitialLoad(false);
    }
  };
  
  const formatCakesFromAPIOptimized = (apiCakes, category) => {
    return apiCakes.map((cake, index) => ({
      id: `api_${category.key}_${cake.id || index}_${Date.now()}`,
      type: 'cake',
      image: cake.image || cake.image_url,
      height: getRandomHeight(),
      name: cake.name || cake.title || 'Delicious Cake',
      price: cake.price ? `QAR ${cake.price}` : 'QAR 199',
      rating: cake.rating || 4.8,
      category: category.key,
      categoryName: category.name,
      description: cake.description || `Beautiful ${category.name.toLowerCase()} cake`,
      isNew: cake.is_new || false,
      purchases: cake.purchases || 0,
      // ‚ú® PERFORMANCE: Add loading priority
      priority: index < 6 ? 'high' : 'normal', // First 6 images get high priority
      batchIndex: Math.floor(index / PERFORMANCE_CONFIG.PAGINATION_SIZE),
      // ‚ú® NUCLEAR: Mark as API data
      dataSource: 'api',
    }));
  };
  
  const createOptimizedMasonryData = () => {
    console.log(`üé® Communication #62.4 - OPTIMIZED: Creating masonry from ${categoryCakes.length} category cakes (source: ${dataSource})`);
    
    // ‚ú® PERFORMANCE: Don't shuffle immediately, load in order for better UX
    const sortedCakes = [...categoryCakes].sort((a, b) => {
      // High priority images first
      if (a.priority === 'high' && b.priority !== 'high') return -1;
      if (b.priority === 'high' && a.priority !== 'high') return 1;
      return 0;
    });
    
    setGalleryData(sortedCakes);
    
    // Reset column heights for new layout
    setColumnHeights(Array(COLUMN_COUNT).fill(0));
  };
  
  // ============================================================================
  // ‚ú® OPTIMIZED INFINITE SCROLLING - Communication #62.4
  // ============================================================================
  
  const loadMoreDataOptimized = useCallback(async () => {
    if (loading || !hasMoreData || !selectedCategory) return;
    
    setLoading(true);
    console.log(`üìÑ Communication #62.4 - OPTIMIZED: Loading more data (batch ${page + 1}, source: ${dataSource})`);
    
    try {
      if (dataSource === 'props' && window.remainingLocalCakes) {
        // ‚ú® NUCLEAR: Load more from local data
        const nextBatch = window.remainingLocalCakes.slice(0, PERFORMANCE_CONFIG.PAGINATION_SIZE);
        window.remainingLocalCakes = window.remainingLocalCakes.slice(PERFORMANCE_CONFIG.PAGINATION_SIZE);
        
        if (nextBatch.length > 0) {
          setCategoryCakes(prev => [...prev, ...nextBatch]);
          setPage(prev => prev + 1);
          
          console.log(`‚úÖ Communication #62.4 - LOCAL: Loaded ${nextBatch.length} more local cakes`);
          
          if (window.remainingLocalCakes.length === 0) {
            setHasMoreData(false);
            console.log(`üîö Communication #62.4 - All local cakes loaded`);
          }
        } else {
          setHasMoreData(false);
        }
        
      } else if (dataSource === 'api') {
        // ‚ú® PRESERVED: API pagination
        const nextPage = page + 1;
        console.log(`üìÑ Communication #62.4 - Loading page ${nextPage} for category: ${selectedCategory.name}`);
        
        const moreCategoryData = await ApiService.getCakesByCategory(currentCategoryKey, {
          limit: PERFORMANCE_CONFIG.PAGINATION_SIZE, // Only 8 more images per load
          page: nextPage,
          clearPrevious: false
        });
        
        if (moreCategoryData.results && moreCategoryData.results.length > 0) {
          const newCakes = formatCakesFromAPIOptimized(moreCategoryData.results, selectedCategory);
          
          // ‚ú® PERFORMANCE: Add new cakes with staggered loading
          setCategoryCakes(prev => [...prev, ...newCakes]);
          setPage(nextPage);
          
          console.log(`‚úÖ Communication #62.4 - API: Loaded ${newCakes.length} more cakes (page ${nextPage})`);
        } else {
          setHasMoreData(false);
          console.log(`üîö Communication #62.4 - No more API cakes for ${selectedCategory.name}`);
        }
      }
      
    } catch (error) {
      console.error('‚ùå Communication #62.4 - Error loading more data:', error);
    } finally {
      setLoading(false);
    }
  }, [loading, hasMoreData, page, selectedCategory, currentCategoryKey, dataSource]);
  
  // ============================================================================
  // ‚ú® LAZY IMAGE LOADING INTEGRATION - Communication #62.4
  // ============================================================================
  
  const handleImageLoaded = useCallback(() => {
    setLoadedImageCount(prev => {
      const newCount = prev + 1;
      const progress = totalImageCount > 0 ? (newCount / totalImageCount) * 100 : 0;
      setLoadingProgress(progress);
      
      if (newCount === totalImageCount) {
        console.log(`üéâ Communication #62.4 - All images loaded! (${newCount}/${totalImageCount}) from ${dataSource}`);
      }
      
      return newCount;
    });
  }, [totalImageCount, dataSource]);
  
  // ============================================================================
  // üõí NEW: ADD-TO-CART FUNCTIONALITY - Communication #64.3
  // ============================================================================
  
  const handleAddToCartPress = useCallback((item, event) => {
    // Stop event propagation to prevent triggering onCakePress
    if (event) {
      event.stopPropagation();
    }
    
    // Animate button press
    Animated.sequence([
      Animated.timing(addToCartScale, {
        toValue: 0.9,
        duration: 100,
        useNativeDriver: true,
      }),
      Animated.timing(addToCartScale, {
        toValue: 1,
        duration: 100,
        useNativeDriver: true,
      }),
    ]).start();
    
    // Call parent handler if provided
    if (onAddToCart) {
      console.log(`üõí Communication #64.3 - Add to cart: ${item.name} (${item.price})`);
      onAddToCart(item);
    } else {
      // Fallback: use onCakePress with action type
      console.log(`üõí Communication #64.3 - Add to cart fallback: ${item.name}`);
      if (onCakePress) {
        onCakePress(item, { action: 'addToCart' });
      }
    }
  }, [onAddToCart, onCakePress, addToCartScale]);
  
  // ============================================================================
  // PRESERVED METHODS - Communication #62.4
  // ============================================================================
  
  const initializeGallery = () => {
    console.log('üé® EnhancedGallery: Initializing optimized masonry layout');
    if (!selectedCategory) {
      createMasonryData(); // Fallback for non-category usage
    }
  };
  
  const startEntranceAnimation = () => {
    Animated.parallel([
      Animated.timing(galleryOpacity, {
        toValue: 1,
        duration: 800,
        useNativeDriver: true,
      }),
      Animated.spring(headerScale, {
        toValue: 1,
        tension: 50,
        friction: 8,
        useNativeDriver: true,
      }),
    ]).start();
  };
  
  const createMasonryData = () => {
    // Fallback for non-category mode (preserved)
    const allItems = [];
    
    galleryImages.forEach((image, index) => {
      allItems.push({
        id: `gallery_${index}`,
        type: 'gallery',
        image: image,
        height: getRandomHeight(),
        name: t('superDuperHome.gallery.creativeDesign', 'Creative Design'),
        category: 'gallery',
        priority: index < 6 ? 'high' : 'normal',
      });
    });
    
    if (!selectedCategory) {
      cakes.forEach((cake, index) => {
        allItems.push({
          id: `cake_${cake.id || index}`,
          type: 'cake',
          image: cake.image,
          height: getRandomHeight(),
          name: cake.name,
          price: cake.price,
          rating: cake.rating,
          category: cake.category || 'custom',
          priority: index < 6 ? 'high' : 'normal',
        });
      });
    }
    
    setGalleryData(allItems);
    setTotalImageCount(allItems.length);
  };
  
  const getRandomHeight = () => {
    const baseHeight = 180;
    const variation = 80;
    return Math.floor(baseHeight + Math.random() * variation);
  };
  
  const handleRefresh = useCallback(async () => {
    setRefreshing(true);
    setPage(1);
    setHasMoreData(true);
    setLoadedImageCount(0);
    setLoadingProgress(0);
    
    if (selectedCategory) {
      console.log(`üîÑ Communication #62.4 - OPTIMIZED: Refreshing category: ${selectedCategory.name}`);
      await handleCategoryChangeOptimized(selectedCategory);
    } else {
      createMasonryData();
      await new Promise(resolve => setTimeout(resolve, 1000));
    }
    
    setRefreshing(false);
  }, [selectedCategory]);
  
  // ============================================================================
  // ‚ú® OPTIMIZED RENDER METHODS - Communication #62.4 & #64.3
  // ============================================================================
  
  const renderGalleryHeader = () => (
    <Animated.View 
      style={[
        styles.galleryHeader,
        { 
          transform: [{ scale: headerScale }],
          opacity: galleryOpacity,
        }
      ]}
    >
      <View style={styles.headerContent}>
        <Text style={styles.sectionTitle}>
          {selectedCategory 
            ? (currentLanguage === 'ar' 
                ? `ŸÉŸäŸÉÿßÿ™ ${selectedCategory.nameAr || selectedCategory.name}` 
                : `${selectedCategory.name} Cakes`)
            : t('superDuperHome.gallery.title', 'Cake Gallery')
          }
        </Text>
        <View style={styles.subtitleContainer}>
          <Text style={styles.sectionSubtitle}>
            {selectedCategory 
              ? `${categoryCakes.length} ${t('common.cakes', 'cakes')} ‚Ä¢ ${selectedCategory.name} ‚Ä¢ ${dataSource}`
              : (currentLanguage === 'ar' ? 'ŸÖÿπÿ±ÿ∂ ÿßŸÑŸÉŸäŸÉ ÿßŸÑŸÅŸÜŸä' : 'Artisan Creations')
            }
          </Text>
          
          {/* ‚ú® PERFORMANCE: Loading progress indicator */}
          {isInitialLoad && totalImageCount > 0 && (
            <View style={styles.progressContainer}>
              <View style={styles.progressBar}>
                <View 
                  style={[
                    styles.progressFill, 
                    { width: `${loadingProgress}%` }
                  ]} 
                />
              </View>
              <Text style={styles.progressText}>
                {Math.round(loadingProgress)}% loaded ({loadedImageCount}/{totalImageCount}) from {dataSource}
              </Text>
            </View>
          )}
        </View>
      </View>
      
      <View style={styles.layoutControls}>
        <TouchableOpacity
          style={[
            styles.layoutButton,
            layoutMode === 'masonry' && styles.layoutButtonActive
          ]}
          onPress={() => setLayoutMode('masonry')}
        >
          <Text style={styles.layoutButtonText}>‚öè</Text>
        </TouchableOpacity>
        
        <TouchableOpacity
          style={[
            styles.layoutButton,
            layoutMode === 'grid' && styles.layoutButtonActive
          ]}
          onPress={() => setLayoutMode('grid')}
        >
          <Text style={styles.layoutButtonText}>‚öè</Text>
        </TouchableOpacity>
      </View>
    </Animated.View>
  );
  
  // üé® ENHANCED: Gallery item with improved price display and add-to-cart - Communication #64.3
  const renderOptimizedGalleryItem = ({ item, index }) => {
    const column = index % COLUMN_COUNT;
    const itemStyle = {
      width: COLUMN_WIDTH,
      height: item.height,
      marginBottom: ITEM_MARGIN,
      marginLeft: column > 0 ? ITEM_MARGIN : 0,
    };
    
    return (
      <View style={itemStyle}>
        <LazyImage
          uri={item.image}
          style={styles.cakeImage}
          resizeMode="cover"
          priority={item.priority || 'normal'}
          loadOnMount={index < 4} // Load first 4 images immediately
          onLoad={handleImageLoaded}
          onPress={() => onCakePress && onCakePress(item)}
          fallbackUri={`https://via.placeholder.com/300x${item.height}/f0f0f0/999?text=Cake`}
        >
          {/* Enhanced overlay content - Communication #64.3 */}
          <View style={styles.itemOverlay}>
            <LinearGradient
              colors={['transparent', 'rgba(0,0,0,0.7)']}
              style={styles.overlayGradient}
            >
              <View style={styles.itemContent}>
                {/* üõí NEW: Add to Cart Button - Communication #64.3 */}
                {item.type === 'cake' && (
                  <Animated.View 
                    style={[
                      styles.addToCartButton,
                      { transform: [{ scale: addToCartScale }] }
                    ]}
                  >
                    <TouchableOpacity
                      style={styles.addToCartTouchable}
                      onPress={(event) => handleAddToCartPress(item, event)}
                      activeOpacity={0.8}
                    >
                      <Text style={styles.addToCartIcon}>+</Text>
                    </TouchableOpacity>
                  </Animated.View>
                )}
                
                {/* Main content area */}
                <View style={styles.itemMainContent}>
                  <Text style={styles.itemName} numberOfLines={2}>
                    {currentLanguage === 'ar' ? item.nameAr || item.name : item.name}
                  </Text>
                  {item.rating && (
                    <Text style={styles.itemRating}>‚≠ê {item.rating}</Text>
                  )}
                </View>
                
                {/* üí∞ ENHANCED: Price Display - Communication #64.3 */}
                {item.price && (
                  <View style={styles.enhancedPriceContainer}>
                    <Text style={styles.enhancedPriceText}>{item.price}</Text>
                  </View>
                )}
                
                {/* ‚ú® DEBUG: Show data source */}
                <Text style={styles.dataSourceBadge}>
                  {item.dataSource || dataSource}
                </Text>
              </View>
            </LinearGradient>
          </View>
        </LazyImage>
      </View>
    );
  };
  
  const renderLoadingFooter = () => {
    if (!loading && !categoryLoading) return null;
    
    return (
      <View style={styles.loadingFooter}>
        <ActivityIndicator size="large" color={QatarColors.secondary} />
        <Text style={styles.loadingText}>
          {categoryLoading 
            ? `Loading ${selectedCategory?.name} cakes from ${dataSource}...`
            : `Loading more cakes (${PERFORMANCE_CONFIG.PAGINATION_SIZE} images) from ${dataSource}...`
          }
        </Text>
      </View>
    );
  };
  
  const renderEmptyState = () => (
    <View style={styles.emptyState}>
      <Text style={styles.emptyIcon}>
        {selectedCategory ? 'üç∞' : 'üé®'}
      </Text>
      <Text style={styles.emptyTitle}>
        {selectedCategory 
          ? `No cakes found - ${selectedCategory.name}`
          : 'No Gallery Items'
        }
      </Text>
      <Text style={styles.emptySubtitle}>
        {selectedCategory 
          ? `Tried: ${dataSource} data source`
          : 'Gallery items will appear here'
        }
      </Text>
    </View>
  );
  
  // ============================================================================
  // ‚ú® OPTIMIZED MAIN RENDER - Communication #62.4
  // ============================================================================
  
  return (
    <Animated.View 
      style={[
        styles.container,
        style,
        { opacity: galleryOpacity }
      ]}
    >
      {renderGalleryHeader()}
      
      <FlatList
        data={galleryData}
        renderItem={renderOptimizedGalleryItem}
        keyExtractor={(item) => item.id}
        numColumns={COLUMN_COUNT}
        contentContainerStyle={styles.galleryContainer}
        showsVerticalScrollIndicator={false}
        onEndReached={loadMoreDataOptimized}
        onEndReachedThreshold={PERFORMANCE_CONFIG.PRELOAD_THRESHOLD}
        refreshControl={
          <RefreshControl
            refreshing={refreshing}
            onRefresh={handleRefresh}
            tintColor={QatarColors.secondary}
            progressBackgroundColor={QatarColors.surface}
          />
        }
        ListEmptyComponent={renderEmptyState}
        ListFooterComponent={renderLoadingFooter}
        // ‚ú® PERFORMANCE OPTIMIZATIONS - Communication #62.4
        maxToRenderPerBatch={PERFORMANCE_CONFIG.PAGINATION_SIZE}
        windowSize={10}
        initialNumToRender={PERFORMANCE_CONFIG.INITIAL_BATCH_SIZE}
        removeClippedSubviews={true}
        scrollEventThrottle={16}
        getItemLayout={null} // Let FlatList calculate for masonry
        updateCellsBatchingPeriod={50}
        onScroll={Animated.event(
          [{ nativeEvent: { contentOffset: { y: scrollY } } }],
          { useNativeDriver: false }
        )}
      />
    </Animated.View>
  );
};

// ============================================================================
// ‚ú® ENHANCED STYLES WITH NEW UI/UX COMPONENTS - Communication #64.3
// ============================================================================

const styles = {
  container: {
    flex: 1,
    paddingHorizontal: Spacing.md,
  },
  
  galleryHeader: {
    marginBottom: Spacing.lg,
  },
  
  headerContent: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'flex-start',
    marginBottom: Spacing.sm,
  },
  
  subtitleContainer: {
    flex: 1,
  },
  
  sectionTitle: {
    fontSize: Typography.fontSize.xl,
    fontWeight: Typography.fontWeight.bold,
    color: QatarColors.textPrimary,
    flex: 1,
  },
  
  sectionSubtitle: {
    fontSize: Typography.fontSize.sm,
    color: QatarColors.secondary,
    fontWeight: Typography.fontWeight.medium,
    marginTop: Spacing.xs,
  },
  
  // ‚ú® NEW: Progress indicator styles
  progressContainer: {
    marginTop: Spacing.sm,
  },
  
  progressBar: {
    height: 4,
    backgroundColor: 'rgba(255,255,255,0.2)',
    borderRadius: 2,
    overflow: 'hidden',
  },
  
  progressFill: {
    height: '100%',
    backgroundColor: QatarColors.secondary,
    borderRadius: 2,
  },
  
  progressText: {
    fontSize: Typography.fontSize.xs,
    color: QatarColors.textSecondary,
    marginTop: 4,
  },
  
  layoutControls: {
    flexDirection: 'row',
    backgroundColor: QatarColors.surface,
    borderRadius: 20,
    padding: 4,
  },
  
  layoutButton: {
    paddingHorizontal: Spacing.sm,
    paddingVertical: Spacing.xs,
    borderRadius: 16,
    marginHorizontal: 2,
  },
  
  layoutButtonActive: {
    backgroundColor: QatarColors.secondary,
  },
  
  layoutButtonText: {
    fontSize: Typography.fontSize.sm,
    color: QatarColors.textPrimary,
  },
  
  galleryContainer: {
    paddingBottom: Spacing.xl,
  },
  
  // ‚ú® OPTIMIZED: Image and overlay styles
  cakeImage: {
    width: '100%',
    height: '100%',
    borderRadius: 12,
  },
  
  itemOverlay: {
    position: 'absolute',
    bottom: 0,
    left: 0,
    right: 0,
    height: '50%',
  },
  
  overlayGradient: {
    flex: 1,
    justifyContent: 'flex-end',
    borderRadius: 12,
  },
  
  itemContent: {
    padding: Spacing.sm,
    position: 'relative',
  },
  
  // üõí NEW: Add to Cart Button Styles - Communication #64.3
  addToCartButton: {
    position: 'absolute',
    top: 8,
    left: 8,
    zIndex: 10,
  },
  
  addToCartTouchable: {
    width: 44,
    height: 44,
    borderRadius: 22,
    backgroundColor: QatarColors.primary || '#8B0000', // Qatar Maroon
    justifyContent: 'center',
    alignItems: 'center',
    elevation: 4,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.25,
    shadowRadius: 4,
  },
  
  addToCartIcon: {
    fontSize: 24,
    fontWeight: 'bold',
    color: '#FFFFFF',
  },
  
  // Enhanced main content area
  itemMainContent: {
    marginTop: 44 + 8, // Account for add-to-cart button
    marginBottom: 8,
  },
  
  itemName: {
    fontSize: Typography.fontSize.sm,
    fontWeight: Typography.fontWeight.bold,
    color: QatarColors.textOnPrimary,
    marginBottom: 4,
  },
  
  itemRating: {
    fontSize: Typography.fontSize.xs,
    color: QatarColors.textOnPrimary,
    marginTop: 2,
  },
  
  // üí∞ ENHANCED: Price Display Styles - Communication #64.3
  enhancedPriceContainer: {
    position: 'absolute',
    bottom: 8,
    right: 8,
    backgroundColor: 'rgba(212, 175, 55, 0.95)', // Qatar Gold with transparency
    paddingHorizontal: 12,
    paddingVertical: 6,
    borderRadius: 16,
    elevation: 3,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 1 },
    shadowOpacity: 0.2,
    shadowRadius: 2,
    borderWidth: 1,
    borderColor: 'rgba(255, 255, 255, 0.3)',
  },
  
  enhancedPriceText: {
    fontSize: Typography.fontSize.md, // Larger than before (was xs)
    fontWeight: Typography.fontWeight.bold,
    color: '#FFFFFF',
    textShadowColor: 'rgba(0, 0, 0, 0.5)',
    textShadowOffset: { width: 1, height: 1 },
    textShadowRadius: 2,
  },
  
  // ‚ú® PRESERVED: Original price style (fallback)
  itemPrice: {
    fontSize: Typography.fontSize.xs,
    color: QatarColors.secondary,
    fontWeight: Typography.fontWeight.medium,
  },
  
  // ‚ú® NEW: Data source debug badge
  dataSourceBadge: {
    fontSize: Typography.fontSize.xs,
    color: QatarColors.secondary,
    marginTop: 2,
    opacity: 0.7,
  },
  
  loadingFooter: {
    padding: Spacing.lg,
    alignItems: 'center',
  },
  
  loadingText: {
    fontSize: Typography.fontSize.sm,
    color: QatarColors.textSecondary,
    marginTop: Spacing.sm,
    fontWeight: Typography.fontWeight.medium,
    textAlign: 'center',
  },
  
  emptyState: {
    padding: Spacing.xl,
    alignItems: 'center',
  },
  
  emptyIcon: {
    fontSize: 48,
    marginBottom: Spacing.md,
  },
  
  emptyTitle: {
    fontSize: Typography.fontSize.lg,
    fontWeight: Typography.fontWeight.bold,
    color: QatarColors.textPrimary,
    marginBottom: Spacing.sm,
    textAlign: 'center',
  },
  
  emptySubtitle: {
    fontSize: Typography.fontSize.sm,
    color: QatarColors.textSecondary,
    textAlign: 'center',
  },
};

export default EnhancedCakeGallery;